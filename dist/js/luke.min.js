"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol==="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};var staticLocalStaffList=null;var timeTable=["20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30","0:00","0:30"];var staticNameList=[];var scheduleHistoryHtml="";$(document).ready(function(){init(function(){initPopovers();bindEvents();bindDrawLine();if(typeof sessionStorage.authorized==="undefined"){$("div#modal_authorize").modal("show")}});$("input#edit_lock").bootstrapSwitch({state:false,size:"small",onText:"\u2714",offText:"\u2718",onSwitchChange:function a(){var c=$("input#edit_lock").bootstrapSwitch("state");var b=$("div#schedule");if(c===true){b.find("table thead th").children("span").show();b.children("div").show()}else{if(c===false){b.find("table thead th").children("span").hide();b.children("div").hide()}}}});makeDraggable($("div#staff_list"),$("button#staff_list_move_handle"))});function init(a){$("div#schedule").children("h3").text(new Date().toLocaleDateString().replace(/\//g,"-"));requestStaff(function(){requestSchedule(null,a)});requestScheduleList()}function requestStaff(a){$.post("php/StaffList.php",function(d,b){if(b==="success"){var c=JSON.parse(d);if(c.code===0){staticLocalStaffList=c.data.staff_real;loadStaffList(c.data.staff_in_order);if(a==null){$.toast({text:"已获取最新团员列表",showHideTransition:"fade",icon:"info"})}}else{$.toast({heading:"error",text:c.msg,showHideTransition:"fade",icon:"error"})}if(a!==null&&typeof a==="function"){a()}}else{$.toast({heading:"获取团员列表失败",text:"请稍后尝试刷新页面",showHideTransition:"fade",icon:"error",hideAfter:false})}})}function requestSchedule(b,a){$.post("php/ScheduleSL.php",{method:"load",id:b},function(e,c){if(c==="success"){var d=JSON.parse(e);if(d.code===0){if(d.data){constructChart(d.data.datatime,d.data.content);loadCheck()}if(a==null){$.toast({text:"排表载入完成",showHideTransition:"fade",icon:"info"})}}else{$.toast({heading:"error",text:d.msg,showHideTransition:"fade",icon:"error"})}if(a!==null&&typeof a==="function"){a()}}else{$.toast({heading:"获取排表失败",text:"请稍后尝试刷新页面",showHideTransition:"fade",icon:"error",hideAfter:false})}})}function requestScheduleList(){$.post("php/ScheduleList.php",function(d,a){if(a==="success"){var b=JSON.parse(d);if(b.code===0){if(b.data){var c=b.data;var e="<ul>";c.forEach(function(f){e+="<li><a class='schedule-history' data-id=\""+f.id+'">'+f.datatime.substr(0,10)+"</a></li>"});e+="</ul>";scheduleHistoryHtml=e}else{scheduleHistoryHtml="暂无排表历史"}}else{scheduleHistoryHtml="暂无排表历史";$.toast({heading:"error",text:b.msg,showHideTransition:"fade",icon:"error"})}}else{scheduleHistoryHtml="暂无排表历史";$.toast({heading:"获取排表历史失败",text:"请稍后尝试刷新页面",showHideTransition:"fade",icon:"error",hideAfter:false})}})}function constructChart(d,c){var e=JSON.parse(c.replace(/[\u4e00-\u9fa5\w]+/g,function(f){return'"'+f+'"'}));if(e instanceof Array){var b=$("div#schedule");b.html("");b.append('<h3 class="text-center">'+d.substr(0,10)+"</h3>");b.append('<input title="在排表区查找对象" type="search" class="pull-right" id="schedule_search" autocomplete="off">');var a="";e.forEach(function(g,f){if(g instanceof Array){a+='<table class="table table-bordered text-center"><thead><tr>\n <th class="bg-success">'+timeTable[f]+'\n     <span class="pull-right" style="display: none;">\n         <button title="在该时间段末尾增加一个团" type="button" class="btn btn-info btn-xxs" name="row-add">\n             <span class="glyphicon glyphicon-plus"></span>\n         </button>\n         <button title="将该时间段末尾的团删去" type="button" class="btn btn-info btn-xxs" name="row-delete">\n             <span class="glyphicon glyphicon-minus"></span>\n         </button>\n     </span>\n </th>\n <th class="text-center" colspan="4">光</th>\n <th class="text-center" colspan="4">暗</th>\n </tr></thead><tbody>';g.forEach(function(i,h){if(i instanceof Array){a+='<tr><th scope="row">'+String.fromCharCode(65+h)+"</th>";i.forEach(function(k){k=parseInt(k);if(k===0){a+="<td></td>"}else{var j=staticLocalStaffList[k-1];if(parseInt(j.id)===k){a+='<td data-id="'+j.id+'" data-name="'+j.name+'">'+j.name+j.career+"</td>"}else{alert("错误代码604，请告知小明")}}});a+="</tr>"}else{return false}});a+="</tbody></table>"}else{return false}});b.append(a);b.append('<div class="text-center" style="margin-bottom: 15px;display: none;">\n <button title="末尾增加一个时间段" type="button" class="btn btn-primary btn-sm" name="chart-add">\n     <span class="glyphicon glyphicon-plus"></span>\n </button>\n <button title="删去末尾的时间段" type="button" class="btn btn-primary btn-sm" name="chart-delete">\n     <span class="glyphicon glyphicon-minus"></span>\n </button></div>')}else{return false}}function initPopovers(){$("button#staff_list_add_btn").popover({content:"一次只能新增一个空白团员",placement:"top",trigger:"manual"}).on("click",addStaff).on("blur",function(){$(this).popover("hide")});$("button#staff_attr_save_btn").popover({content:"请先在左侧团员列表选中其一",placement:"top",trigger:"manual"}).on("click",saveStaff).on("blur",function(){$(this).popover("hide")});$("button#staff_attr_del_btn").popover({content:"请先在左侧团员列表选中其一",placement:"top",trigger:"manual"}).on("click",deleteStaff).on("blur",function(){$(this).popover("hide")});$("button#schedule_history_btn").popover({content:scheduleHistoryHtml,html:true,placement:"bottom",trigger:"focus"})}function bindEvents(){var a=$("div#schedule");$("div#staff_list").children("div").on("click","button",function(b){readStaffAttributes(b)});$("div#staff_list_filter").find("input[name='options']").on("change",filterStaff);$("input#staff_search").on("change keydown",function(d){if(d.type==="keydown"&&d.keyCode!==13){return}var b=$("div#staff_list").children("div").children("button");var c=$(this).val().trim();if(c===""){b.show()}else{b.hide().filter(":contains("+c+")").show()}});a.on("change keydown","input#schedule_search",function(d){if(d.type==="keydown"&&d.keyCode!==13){return}var c=$("div#schedule").find("tbody tr td");var b=$(this).val().trim();if(b===""){c.removeClass("schedule-search-result")}else{c.removeClass("schedule-search-result").filter(":contains("+b+")").addClass("schedule-search-result")}});$("div#modal_add_name").on("show.bs.modal",function(){$(this).css("display","block");var b=$(window).height()/2-$("div#modal_add_name").find(".modal-dialog").height()/2;$(this).find(".modal-dialog").css({"margin-top":b})}).on("shown.bs.modal",function(){$("input#modal_add_name_input").focus()});$("input#modal_add_name_input").on("keydown",function(b){if(b.keyCode===13){addName()}});$("div#modal_authorize").on("show.bs.modal",function(){$(this).css("display","block");var b=$(window).height()/2-$("div#modal_authorize").find(".modal-dialog").height()/2;$(this).find(".modal-dialog").css({"margin-top":b})}).on("shown.bs.modal",function(){$("input#modal_authorize_input").focus()});$("input#modal_authorize_input").on("keydown",function(b){if(b.keyCode===13){checkAuth()}});a.on("click","[name='row-add']",function(){var b=$(this).parentsUntil("div#schedule").filter("table");var c=b.find("tbody tr").length;if(c>=7){return}b.append('<tr><th scope="row">'+String.fromCharCode(65+c)+"队</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");resizeSVG()}).on("click","[name='row-delete']",function(){var c=$(this).parentsUntil("div#schedule").filter("table").find("tbody tr");var b=c.length;if(b<=1){return}c.eq(b-1).remove();resizeSVG()}).on("click","[name='chart-add']",function(){var b=$("div#schedule").children("table").length;if(b>=10){return}$('<table class="table table-bordered text-center">\n<thead>\n<tr>\n    <th class="bg-success">'+timeTable[b]+'\n        <span class="pull-right">\n            <button title="在该时间段末尾增加一个团"  type="button" class="btn btn-info btn-xxs" name="row-add">\n                <span class="glyphicon glyphicon-plus"></span>\n            </button>\n            <button title="将该时间段末尾的团删去" type="button" class="btn btn-info btn-xxs" name="row-delete">\n                <span class="glyphicon glyphicon-minus"></span>\n            </button>\n        </span>\n    </th>\n    <th class="text-center" colspan="4">光</th>\n    <th class="text-center" colspan="4">暗</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n    <th scope="row">A队</th>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n</tr>\n</tbody>\n</table>').insertBefore("div#schedule>div");resizeSVG()}).on("click","[name='chart-delete']",function(){var b=$("div#schedule").children("table");var c=b.length;if(c<=1){return}b.eq(c-1).remove();resizeSVG()});$("button#export_btn").on("click",function(){html2canvas($("div#schedule").get(0)).then(function(b){$("img#screen_shot_img").attr("src",b.toDataURL())});$("div#modal_img").modal("show")});$(".page-header").on("click","a.schedule-history",function(){var b=$(this).attr("data-id");requestSchedule(b,null)})}function experience(){sessionStorage.authorized="false";$("div#modal_authorize").modal("hide")}function checkAuth(){var b=$("input#modal_authorize_input").val().trim();var a=$("button#btn_auth_enter");var c=$("span#helpBlock");$.post("php/AuthCheck.php",{auth:b},function(f,d){if(d==="success"){var e=JSON.parse(f);if(e.code===0){if(parseInt(e.data)===1){c.html("<b>团员授权</b>：只可保存团员区改动");a.prop("disabled",false)}else{if(parseInt(e.data)===2){c.html("<b>团长授权</b>：可保存所有改动");a.prop("disabled",false)}}}else{if(e.code===2){c.text("授权码不对，无保存权限，请联系小明");a.prop("disabled",true)}else{$.toast({heading:"error",text:e.msg,showHideTransition:"fade",icon:"error"})}}}})}function authorize(){sessionStorage.auth=$("input#modal_authorize_input").val().trim();sessionStorage.authorized="true";$("div#modal_authorize").modal("hide")}function readStaffAttributes(b){var d=parseInt(b.target.getAttribute("data-id"));$("div#staff_attr_panel").attr("data-id",d);if(d===0){resetStaffAttributesPanel();return}var a=staticLocalStaffList[d-1];if(parseInt(a.id)===d){var c=staticNameList.indexOf(a.name);$("select#staff_attr_name_select").val(c);$("input#staff_attr_career_input").val(a.career);$("select#staff_attr_type_select").val(a.type);$("input#staff_attr_absence_check").prop("checked",a.absence==="1");$("div#staff_attr_other_attack").children("label").removeClass("active").eq(a.attack-1).addClass("active");$("div#staff_attr_other_control").children("label").removeClass("active").eq(a.control-1).addClass("active");$("div#staff_attr_other_element").children("label").removeClass("active").eq(a.element-1).addClass("active")}else{alert("错误代码600，请告知小明")}}function resetStaffAttributesPanel(){$("select#staff_attr_name_select").val(-1);$("input#staff_attr_career_input").val("");$("select#staff_attr_type_select").val(0);$("input#staff_attr_absence_check").prop("checked",false);$("div#staff_attr_other_attack").children("label").removeClass("active").eq(0).addClass("active");$("div#staff_attr_other_control").children("label").removeClass("active").eq(0).addClass("active");$("div#staff_attr_other_element").children("label").removeClass("active").eq(0).addClass("active")}function loadStaffList(b){var a=$("div#staff_list").children("div");a.empty();$.each(b,function(d,e){if(staticNameList.indexOf(e.name)===-1){staticNameList.push(e.name)}var c=document.createElement("button");c.setAttribute("type","button");c.setAttribute("data-id",e.id);c.className="btn btn-default";c.innerHTML=e.name+e.career;if(e.type==="1"){c.className+=" career-c"}else{if(e.type==="2"){c.className+=" career-assist"}else{if(e.type==="3"){c.className+=" career-priest"}}}if(e.absence==="1"){c.className+=" career-absence"}a.append(c)});resizeSVG();loadNameList();resetStaffAttributesPanel()}function loadNameList(){var a=$("select#staff_attr_name_select");a.empty();a.append(new Option("称谓","-1"));$.each(staticNameList,function(b,c){a.append(new Option(c,b))})}function loadCheck(){var a=$("div#schedule").find("tbody tr td");var b=$("div#staff_list").children("div").find("button");b.removeClass("in-schedule");a.each(function(){var e=$(this).text();if(e===null||e===""||e==="空"){return}var c=b.filter(":contains("+e+")");var d=$(this);c.each(function(){if($(this).text()===e){if($(this).hasClass("career-absence")){d.removeAttr("data-id").removeAttr("data-name").text("")}else{if(!$(this).hasClass("in-schedule")){$(this).addClass("in-schedule")}}}})})}function filterStaff(){var a=[".career-c",".career-assist",".career-priest",".in-schedule",".career-absence"];var b=$("div#staff_list");b.find("button[data-id]").show();var c=$("div#staff_list_filter").find("input");c.each(function(){var d=parseInt($(this).attr("data-filter"));if(!$(this).parent().hasClass("active")){$("div#staff_list").find(a[d-1]).hide()}})}function addStaff(){var d=$("div#staff_list").children("div");var a=0;var c=d.children("button").is("[data-id="+a+"]");if(c){$("button#staff_list_add_btn").popover("show");return}var b=document.createElement("button");b.setAttribute("type","button");b.setAttribute("data-id",a.toString());b.className="btn btn-default";b.innerHTML="新增人员";d.append(b)}function addName(){var c=$("input#modal_add_name_input");var b=c.val().trim();var a=$("div#modal_add_name");if(b===null||b===""){a.modal("hide");return}staticNameList.push(b);loadNameList();$("select#staff_attr_name_select").val(staticNameList.length-1);a.modal("hide");c.val("")}function saveStaff(){var c=parseInt($("div#staff_attr_panel").attr("data-id"));var a=$("div#staff_list").children("div").children("button[data-id="+c+"]");if(c===-1||!a.is("button")){$("button#staff_attr_save_btn").popover("show");return}var b={method:"save",auth:sessionStorage.auth,id:c,name:staticNameList[parseInt($("select#staff_attr_name_select").val())],career:$("input#staff_attr_career_input").val().trim(),type:parseInt($("select#staff_attr_type_select").val()),absence:$("input#staff_attr_absence_check").prop("checked"),attack:$("div#staff_attr_other_attack").find("label.active").index()+1,control:$("div#staff_attr_other_control").find("label.active").index()+1,element:$("div#staff_attr_other_element").find("label.active").index()+1};if(sessionStorage.authorized==="true"){$.post("php/StaffAttr.php",b,function(f,d){if(d==="success"){var e=JSON.parse(f);if(e.code===0){requestStaff(null);$.toast({text:"保存成功",showHideTransition:"fade",icon:"success"})}else{if(e.code===5){$.toast({heading:"权限不足",text:'需要团员以上权限才可操作，<a onclick=\'$("div#modal_authorize").modal("show");$(this).siblings(".close-jq-toast-single").click();\'>重新登录</a>',showHideTransition:"fade",hideAfter:false,icon:"warning"})}else{$.toast({heading:"保存失败",text:e.msg,showHideTransition:"fade",icon:"error"})}}}})}else{if(b.id===0){b.id=Math.round(Math.random()*100)+staticLocalStaffList.length;staticLocalStaffList.push(b);a.attr("data-id",b.id)}a.text(b.name+b.career);if(b.type===1){a.attr("class","btn btn-default career-c")}else{if(b.type===2){a.attr("class","btn btn-default career-assist")}else{if(b.type===3){a.attr("class","btn btn-default career-priest")}else{if(b.type===0){a.attr("class","btn btn-default")}}}}if(b.absence){a.addClass("career-absence")}$.toast({heading:"无此权限",text:'体验账号所做修改仅限于页面，不会提交到服务器，<a onclick=\'$("div#modal_authorize").modal("show");$(this).siblings(".close-jq-toast-single").click();\'>重新登录</a>',showHideTransition:"fade",hideAfter:false,icon:"warning"})}}function deleteStaff(){var c=parseInt($("div#staff_attr_panel").attr("data-id"));var b=$("div#staff_list").children("div").children("button[data-id="+c+"]");if(c===-1||!b.is("button")){$("button#staff_attr_del_btn").popover("show");return}if(c===0){b.remove();return}var a=b.text();if(sessionStorage.authorized==="true"){$.post("php/StaffAttr.php",{method:"delete",id:c,auth:sessionStorage.auth},function(f,d){if(d==="success"){var e=JSON.parse(f);if(e.code===0){requestStaff(null);$.toast({heading:"删除成功",text:"已删除<b>"+a+'</b>，<a onclick="undoDeleteStaff('+c+');$(this).siblings(".close-jq-toast-single").click();">撤销删除</a>',showHideTransition:"fade",hideAfter:false,icon:"success"})}else{if(e.code===5){$.toast({heading:"权限不足",text:'需要团员以上权限才可操作，<a onclick=\'$("div#modal_authorize").modal("show");$(this).siblings(".close-jq-toast-single").click();\'>重新登录</a>',showHideTransition:"fade",hideAfter:false,icon:"warning"})}else{$.toast({heading:"删除失败",text:e.msg,showHideTransition:"fade",icon:"error"})}}}})}else{b.remove();if(parseInt(staticLocalStaffList[c-1].id)===c){staticLocalStaffList.splice(c-1,1)}else{alert("错误代码602，请告知小明")}$.toast({heading:"无此权限",text:'体验账号所做修改仅限于页面，不会提交到服务器，<a onclick=\'$("div#modal_authorize").modal("show");$(this).siblings(".close-jq-toast-single").click();\'>重新登录</a>',showHideTransition:"fade",hideAfter:false,icon:"warning"})}}function undoDeleteStaff(a){$.post("php/StaffAttr.php",{method:"undo",id:a,auth:sessionStorage.auth},function(d,b){if(b==="success"){var c=JSON.parse(d);if(c.code===0){requestStaff(null);$.toast({text:"已恢复",showHideTransition:"fade",icon:"info"})}else{if(c.code===5){$.toast({heading:"权限不足",text:'需要团员以上权限才可操作，<a onclick=\'$("div#modal_authorize").modal("show");$(this).siblings(".close-jq-toast-single").click();\'>重新登录</a>',showHideTransition:"fade",hideAfter:false,icon:"warning"})}else{$.toast({heading:"恢复失败",text:c.msg,showHideTransition:"fade",icon:"error"})}}}})}function saveSchedule(){if(sessionStorage.authorized==="true"){var a=extractSchedule();$.post("php/ScheduleSL.php",{method:"save",content:a,auth:sessionStorage.auth},function(d,b){if(b==="success"){var c=JSON.parse(d);if(c.code===0){$.toast({text:"保存成功",showHideTransition:"fade",icon:"success"})}else{if(c.code===5){$.toast({heading:"无此权限",text:'只有团长权限可以保存排表，<a onclick=\'$("div#modal_authorize").modal("show");$(this).siblings(".close-jq-toast-single").click();\'>重新登录</a>',showHideTransition:"fade",hideAfter:false,icon:"warning"})}else{$.toast({heading:"保存失败",text:c.msg,showHideTransition:"fade",icon:"error"})}}}})}else{$.toast({heading:"无此权限",text:'体验账号所做修改仅限于页面，不会提交到服务器，<a onclick=\'$("div#modal_authorize").modal("show");$(this).siblings(".close-jq-toast-single").click();\'>重新登录</a>',showHideTransition:"fade",hideAfter:false,icon:"warning"})}}function extractSchedule(){var b=$("div#schedule");var a=[];b.find("table").each(function(){var c=$(this);var d=[];c.find("tbody tr").each(function(){var e=$(this);var f=[];e.find("td").each(function(){var g=$(this);var h=g.attr("data-id");f.push(h&&h>1?h:0)});d.push("["+f.toString()+"]")});a.push("["+d.toString()+"]")});return"["+a.toString().toString()+"]"}function makeDraggable(b,e){if(!b instanceof jQuery){return}var a=false;var d=void 0,c=void 0;e.on("mousedown",function(f){a=true;d=f.pageX-parseInt(b.css("left"));c=f.pageY-parseInt(b.css("top"))});$(document).on("mousemove",function(h){if(a){var g=h.pageX-d;var f=h.pageY-c;b.css({left:g,top:f})}}).on("mouseup",function(){a=false})}function resizeSVG(){$(".line").css({width:document.body.scrollWidth,height:document.body.scrollHeight})}function bindDrawLine(){$(".line").css({width:document.body.scrollWidth,height:document.body.scrollHeight});var b=false,d=false,a=false;var f=$("svg");var e=void 0;var h=void 0;var c=$("div#staff_list").children("div");c.on("mousedown","button",function(i){b=true;e=parseInt($(i.target).attr("data-id"));f.children("line").attr({x1:i.pageX,y1:i.pageY,x2:i.pageX,y2:i.pageY})});var g=$("div#schedule");g.on("mousedown","table tr td",function(i){b=true;a=true;h=$(i.target);f.children("line").attr({x1:i.pageX,y1:i.pageY,x2:i.pageX,y2:i.pageY})});$(document).on("mousemove",function(i){if(b){if(!f.is(":visible")){f.show()}f.children("line").attr({x2:i.pageX,y2:i.pageY})}}).on("mouseup",function(){if(b){b=false;f.hide();d=true;setTimeout(function(){d=false},50)}});g.on("mouseover","table tr td",function(){if(d){if(a){var l=h.attr("data-id");var s=h.attr("data-name");var n=h.text();var i=$(this);var q=i.attr("data-id");var r=i.attr("data-name");var m=i.text();h.attr("data-id",!q?"":q);h.attr("data-name",!r?"":r);h.text(!m?"":m);i.attr("data-id",!l?"":l);i.attr("data-name",!s?"":s);i.text(!n?"":n);a=false;markDuplicate(false,h);markDuplicate(false,i);return}var u=staticLocalStaffList[e-1];if(parseInt(u.id)===e){var t=parseInt($(this).attr("data-id"));var o=$("div#staff_list");if(u.name!=="空"){var j=$("div#schedule").find("tbody tr td").filter('[data-id="'+e+'"]');j.each(function(){$(this).removeAttr("data-id").removeAttr("data-name").text("")})}$(this).attr("data-id",e).attr("data-name",u.name).text(u.name+u.career);var p=o.find('button[data-id="'+e+'"]');if(!p.hasClass("in-schedule")&&u.name!=="空"){p.addClass("in-schedule");if($("div#staff_list_filter").find("input[data-filter=4]").prop("checked")===false){p.hide()}}if(t>1){var k=o.find('button[data-id="'+t+'"]');k.each(function(){$(this).removeClass("in-schedule").show()})}}else{alert("错误代码603，请告知小明")}d=false;markDuplicate(false,$(this))}})}function markDuplicate(c){if(c){}else{if(_typeof(arguments[1])==="object"){var d=arguments[1];var b=d.parentsUntil("table").find("td");b.css("color","");var a={};$.each(b,function(){var e=$(this).attr("data-name");if(e!=="空"&&!!e){if(typeof a[e]==="undefined"){a[e]=1}else{if(a[e]===1){b.filter("[data-name="+e+"]").css("color","red");a[e]=2}}}})}else{alert("错误代码701，请告知小明")}}};