"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol==="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};var staticLocalJson={staff_auto_increment:0,staff_list:[],auth_pre:"",auth_fun:""};var staticLocalChart=null;var staticNameList=[];$(document).ready(function(){init(function(){loadStaffList();var b=$("div#schedule");if(staticLocalChart!==null&&staticLocalChart!==""){b.html(staticLocalChart);loadCheck()}b.children("h3").text(new Date().toLocaleDateString().replace(/\//g,"-"));initPopovers();bindEvents();bindDrawLine();if(typeof sessionStorage.authorized==="undefined"){$("div#modal_authorize").modal("show")}});$("input#edit_lock").bootstrapSwitch({state:false,size:"small",onText:"\u2714",offText:"\u2718",onSwitchChange:function a(){var c=$("input#edit_lock").bootstrapSwitch("state");var b=$("div#schedule");if(c===true){b.find("table thead th").children("span").show();b.children("div").show()}else{if(c===false){b.find("table thead th").children("span").hide();b.children("div").hide()}}}});makeDraggable($("div#staff_list"),$("button#staff_list_move_handle"))});function init(b){var a=0;$.getJSON("data/luke_config.json",function(c){if(c==null){return}staticLocalJson=c}).done(function(){if(++a===2){b()}});$.get("data/chart.txt",function(c){if(c==null){return}staticLocalChart=c}).done(function(){if(++a===2){b()}})}function initPopovers(){$("button#staff_list_add_btn").popover({content:"一次只能新增一个空白团员",placement:"top",trigger:"manual"}).on("click",addStaff).on("blur",function(){$(this).popover("hide")});$("button#staff_attr_save_btn").popover({content:"请先在左侧团员列表选中其一",placement:"top",trigger:"manual"}).on("click",saveStaff).on("blur",function(){$(this).popover("hide")});$("button#staff_attr_del_btn").popover({content:"请先在左侧团员列表选中其一",placement:"top",trigger:"manual"}).on("click",deleteStaff).on("blur",function(){$(this).popover("hide")})}function bindEvents(){$("div#staff_list").children("div").on("click","button",function(c){readStaffAttributes(c,$(this).index())});window.onbeforeunload=saveToLocal;$("div#staff_list_filter").find("input[name='options']").on("change",filterStaff);$("input#staff_search").on("change keydown",function(f){if(f.type==="keydown"&&f.keyCode!==13){return}var c=$("div#staff_list").children("div").children("button");var d=$(this).val();if(d===""){c.show()}else{c.hide().filter(":contains("+d+")").show()}});$("input#schedule_search").on("change keydown",function(f){if(f.type==="keydown"&&f.keyCode!==13){return}var d=$("div#schedule").find("tbody tr td");var c=$(this).val();if(c===""){d.removeClass("schedule-search-result")}else{d.removeClass("schedule-search-result").filter(":contains("+c+")").addClass("schedule-search-result")}});$("div#modal_add_name").on("show.bs.modal",function(){$(this).css("display","block");var c=$(window).height()/2-$("div#modal_add_name").find(".modal-dialog").height()/2;$(this).find(".modal-dialog").css({"margin-top":c})}).on("shown.bs.modal",function(){$("input#modal_add_name_input").focus()});$("input#modal_add_name_input").on("keydown",function(c){if(c.keyCode===13){addName();$(this).val("")}});$("div#modal_authorize").on("show.bs.modal",function(){$(this).css("display","block");var c=$(window).height()/2-$("div#modal_authorize").find(".modal-dialog").height()/2;$(this).find(".modal-dialog").css({"margin-top":c})}).on("shown.bs.modal",function(){$("input#modal_authorize_input").focus()});$("input#modal_authorize_input").on("keydown",function(c){if(c.keyCode===13){checkAuth()}});var b=["A","B","C","D","E","F","G"];var a=["20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30","0:00","0:30"];$("div#schedule").on("click","[name='row-add']",function(){var c=$(this).parentsUntil("div#schedule").filter("table");var d=c.find("tbody tr").length;if(d>=7){return}c.append('<tr><th scope="row">'+b[d]+"队</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");resizeSVG()}).on("click","[name='row-delete']",function(){var d=$(this).parentsUntil("div#schedule").filter("table").find("tbody tr");var c=d.length;if(c<=1){return}d.eq(c-1).remove();resizeSVG()}).on("click","[name='chart-add']",function(){var c=$("div#schedule").children("table").length;if(c>=10){return}$('<table class="table table-bordered text-center">\n<thead>\n<tr>\n    <th class="bg-success">'+a[c]+'\n        <span class="pull-right">\n            <button title="在该时间段末尾增加一个团"  type="button" class="btn btn-info btn-xxs" name="row-add">\n                <span class="glyphicon glyphicon-plus"></span>\n            </button>\n            <button title="将该时间段末尾的团删去" type="button" class="btn btn-info btn-xxs" name="row-delete">\n                <span class="glyphicon glyphicon-minus"></span>\n            </button>\n        </span>\n    </th>\n    <th class="text-center" colspan="4">光</th>\n    <th class="text-center" colspan="4">暗</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n    <th scope="row">A队</th>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n</tr>\n</tbody>\n</table>').insertBefore("div#schedule>div");resizeSVG()}).on("click","[name='chart-delete']",function(){var c=$("div#schedule").children("table");var d=c.length;if(d<=1){return}c.eq(d-1).remove();resizeSVG()});$("button#export_btn").on("click",function(){console.log("export");html2canvas($("div#schedule").get(0)).then(function(c){$("img#screen_shot_img").attr("src",c.toDataURL())});$("div#modal_img").modal("show")})}function experience(){sessionStorage.authorized="none";$("div#modal_authorize").modal("hide")}function checkAuth(){var c=$("input#modal_authorize_input").val().trim();var b=$("button#btn_auth_enter");var d=$("span#helpBlock");var a=md5(c);if(a===staticLocalJson.auth_pre){d.text("团长授权：可保存所有改动");b.prop("disabled",false)}else{if(a===staticLocalJson.auth_fun){d.text("团员授权：只可保存团员区改动");b.prop("disabled",false)}else{d.text("授权码不对，无保存权限，请联系小明");b.prop("disabled",true)}}}function authorize(){var b=$("input#modal_authorize_input").val().trim();var a=md5(b);if(a===staticLocalJson.auth_pre){sessionStorage.authorized="premium"}else{if(a===staticLocalJson.auth_fun){sessionStorage.authorized="fundamental"}else{sessionStorage.authorized="none";$("span#helpBlock").text("授权码不对，无保存权限，请联系小明");return}}$("div#modal_authorize").modal("hide")}function readStaffAttributes(c,a){var f=parseInt(c.target.getAttribute("data-id"));$("div#staff_attr_panel").attr("data-id",f);if(f===staticLocalJson.staff_auto_increment){$("select#staff_attr_name_select").val(-1);$("input#staff_attr_career_input").val("");$("select#staff_attr_type_select").val(0);$("input#staff_attr_absence_check").prop("checked",false);$("div#staff_attr_other_attack").children("label").removeClass("active").eq(0).addClass("active");$("div#staff_attr_other_control").children("label").removeClass("active").eq(0).addClass("active");$("div#staff_attr_other_element").children("label").removeClass("active").eq(0).addClass("active");return}var b=staticLocalJson.staff_list;if(b[a].id===f){var d=staticNameList.indexOf(b[a].name);$("select#staff_attr_name_select").val(d);$("input#staff_attr_career_input").val(b[a].career);$("select#staff_attr_type_select").val(b[a].type);$("input#staff_attr_absence_check").prop("checked",b[a].absence);$("div#staff_attr_other_attack").children("label").removeClass("active").eq(b[a].attack-1).addClass("active");$("div#staff_attr_other_control").children("label").removeClass("active").eq(b[a].control-1).addClass("active");$("div#staff_attr_other_element").children("label").removeClass("active").eq(b[a].element-1).addClass("active")}else{console.log(a+" "+b[a].id+" "+f);alert("错误代码600，请告知小明")}}function loadStaffList(){var a=$("div#staff_list").children("div");a.empty();$.each(staticLocalJson.staff_list,function(c,d){if(staticNameList.indexOf(d.name)===-1){staticNameList.push(d.name)}var b=document.createElement("button");b.setAttribute("type","button");b.setAttribute("data-id",d.id);b.className="btn btn-default";b.innerHTML=d.name+d.career;if(d.type===1){b.className+=" career-c"}else{if(d.type===2){b.className+=" career-assist"}else{if(d.type===3){b.className+=" career-priest"}}}if(d.absence){b.className+=" career-absence"}a.append(b)});resizeSVG();loadNameList()}function loadNameList(){var a=$("select#staff_attr_name_select");a.empty();a.append(new Option("称谓","-1"));$.each(staticNameList,function(b,c){a.append(new Option(c,b))})}function loadCheck(){var a=$("div#schedule").find("tbody tr td");var b=$("div#staff_list").children("div").find("button");a.each(function(){var d=$(this).text();if(d===null||d===""||d==="空"){return}var c=b.filter(":contains("+d+")");c.each(function(){if($(this).text()===d){if($(this).hasClass("career-absence")){a.removeAttr("data-name").text("")}else{if(!$(this).hasClass("in-schedule")){$(this).addClass("in-schedule")}}}})})}function filterStaff(){var a=[".career-c",".career-assist",".career-priest",".in-schedule",".career-absence"];var b=$("div#staff_list_filter").find("input");b.each(function(){var c=parseInt($(this).attr("data-filter"));if($(this).parent().hasClass("active")){$("div#staff_list").find(a[c-1]).show()}else{$("div#staff_list").find(a[c-1]).hide()}})}function addStaff(){var d=$("div#staff_list").children("div");var a=staticLocalJson.staff_auto_increment;var c=d.children("button").is("[data-id="+a+"]");if(c){$("button#staff_list_add_btn").popover("show");return}var b=document.createElement("button");b.setAttribute("type","button");b.setAttribute("data-id",a.toString());b.className="btn btn-default";b.innerHTML="新增人员";d.append(b)}function addName(){var c=$("input#modal_add_name_input");var b=c.val().trim();var a=$("div#modal_add_name");if(b===null||b===""){a.modal("hide");return}staticNameList.push(b);loadNameList();$("select#staff_attr_name_select").val(staticNameList.length-1);a.modal("hide");c.val("")}function saveStaff(){var d=parseInt($("div#staff_attr_panel").attr("data-id"));var c=$("div#staff_list").children("div").children("button[data-id="+d+"]");if(d===-1||!c.is("button")){$("button#staff_attr_save_btn").popover("show");return}var a={id:d,name:staticNameList[parseInt($("select#staff_attr_name_select").val())],career:$("input#staff_attr_career_input").val().trim(),type:parseInt($("select#staff_attr_type_select").val()),absence:$("input#staff_attr_absence_check").prop("checked"),attack:$("div#staff_attr_other_attack").find("label.active").index()+1,control:$("div#staff_attr_other_control").find("label.active").index()+1,element:$("div#staff_attr_other_element").find("label.active").index()+1};if(a.id===staticLocalJson.staff_auto_increment){staticLocalJson.staff_list.push(a);staticLocalJson.staff_auto_increment++}else{var b=c.index();if(staticLocalJson.staff_list[b].id===a.id){staticLocalJson.staff_list[b]=a}else{alert("错误代码601，请告知小明")}}c.text(a.name+a.career);if(a.type===1){c.attr("class","btn btn-default career-c")}else{if(a.type===2){c.attr("class","btn btn-default career-assist")}else{if(a.type===3){c.attr("class","btn btn-default career-priest")}else{if(a.type===0){c.attr("class","btn btn-default")}}}}if(a.absence){c.addClass("career-absence")}}function deleteStaff(){var c=parseInt($("div#staff_attr_panel").attr("data-id"));var b=$("div#staff_list").children("div").children("button[data-id="+c+"]");if(c===-1||!b.is("button")){$("button#staff_attr_del_btn").popover("show");return}var a=b.index();b.remove();if(staticLocalJson.staff_auto_increment===c){return}if(staticLocalJson.staff_list[a].id===c){staticLocalJson.staff_list.splice(a,1)}else{alert("错误代码602，请告知小明")}}function saveToLocal(){if(sessionStorage.authorized===null||sessionStorage.authorized==="none"){return}if(sessionStorage.authorized==="premium"){$.ajax({method:"post",url:"php/saveChart.php",async:false,data:{toStore:$("div#schedule").html()}})}if(sessionStorage.authorized==="fundamental"||sessionStorage.authorized==="premium"){var a=JSON.stringify(staticLocalJson,null,4);$.ajax({method:"post",url:"php/saveJSON.php",async:false,data:{toStore:a}})}}function makeDraggable(b,e){if(!b instanceof jQuery){return}var a=false;var d=void 0,c=void 0;e.on("mousedown",function(f){a=true;d=f.pageX-parseInt(b.css("left"));c=f.pageY-parseInt(b.css("top"))});$(document).on("mousemove",function(h){if(a){var g=h.pageX-d;var f=h.pageY-c;b.css({left:g,top:f})}}).on("mouseup",function(){a=false})}function resizeSVG(){$(".line").css({width:document.body.scrollWidth,height:document.body.scrollHeight})}function bindDrawLine(){$(".line").css({width:document.body.scrollWidth,height:document.body.scrollHeight});var f=void 0;var d=void 0;var a=false,c=false;var e=$("svg");var b=$("div#staff_list").children("div");b.on("mousedown","button",function(g){a=true;f=parseInt($(g.target).attr("data-id"));d=parseInt($(g.target).index());e.children("line").attr({x1:g.pageX,y1:g.pageY,x2:g.pageX,y2:g.pageY})});$(document).on("mousemove",function(g){if(a){if(!e.is(":visible")){e.show()}e.children("line").attr({x2:g.pageX,y2:g.pageY})}}).on("mouseup",function(){if(a){a=false;e.hide();c=true;setTimeout(function(){c=false},50)}});$("div#schedule").on("mouseover","table tr td",function(){if(c){var g=staticLocalJson.staff_list[d];if(g.id===f){var l=$(this).text();var j=$("div#staff_list");if(g.name!=="空"){var m=g.name+g.career;var i=$("div#schedule").find("tbody tr td").filter(":contains("+m+")");i.each(function(){if($(this).text()===m){$(this).removeAttr("data-name").text("");markDuplicate(false,$(this))}})}$(this).attr("data-name",g.name).text(g.name+g.career);var h=j.find("button[data-id="+f+"]");if(!h.hasClass("in-schedule")&&g.name!=="空"){h.addClass("in-schedule");if($("div#staff_list_filter").find("input[data-filter=4]").prop("checked")===false){h.hide()}}if(l!==""&&l!=="空"){var k=j.find("button:contains("+l+")");k.each(function(){if($(this).text()===l){$(this).removeClass("in-schedule").show()}})}}else{alert("错误代码603，请告知小明")}c=false;markDuplicate(false,$(this))}})}function markDuplicate(c){if(c){}else{if(_typeof(arguments[1])==="object"){var d=arguments[1];var b=d.parentsUntil("table").find("td");b.css("color","");var a={};$.each(b,function(){var e=$(this).attr("data-name");if(e!=="空"){if(typeof a[e]==="undefined"){a[e]=1}else{if(a[e]===1){b.filter("[data-name="+e+"]").css("color","red");a[e]=2}}}})}else{alert("错误代码701，请告知小明")}}};