"use strict";let staticLocalJson={staff_auto_increment:0,staff_list:[],auth_pre:"",auth_fun:""};let staticLocalChart=null;let staticNameList=[];$(document).ready(function(){init(function(){loadStaffList();let $schedule=$("div#schedule");if(staticLocalChart!==null&&staticLocalChart!==""){$schedule.html(staticLocalChart);loadCheck()}$schedule.children("h3").text(new Date().toLocaleDateString().replace(/\//g,"-"));initPopovers();bindEvents();bindDrawLine();if(typeof sessionStorage.authorized==="undefined"){$("div#modal_authorize").modal("show")}});$("input#edit_lock").bootstrapSwitch({state:false,size:"small",onText:"\u2714",offText:"\u2718",onSwitchChange:function(){let state=$("input#edit_lock").bootstrapSwitch("state");let $chart=$("div#schedule");if(state===true){$chart.find("table thead th").children("span").show();$chart.children("div").show()}else{if(state===false){$chart.find("table thead th").children("span").hide();$chart.children("div").hide()}}}});makeDraggable($("div#staff_list"),$("button#staff_list_move_handle"))});function init(a){let count=0;$.getJSON("data/luke_config.json",function(b){if(b==null){return}staticLocalJson=b}).done(function(){if(++count===2){a()}});$.get("data/chart.txt",function(b){if(b==null){return}staticLocalChart=b}).done(function(){if(++count===2){a()}})}function initPopovers(){$("button#staff_list_add_btn").popover({content:"一次只能新增一个空白团员",placement:"top",trigger:"manual"}).on("click",addStaff).on("blur",function(){$(this).popover("hide")});$("button#staff_attr_save_btn").popover({content:"请先在左侧团员列表选中其一",placement:"top",trigger:"manual"}).on("click",saveStaff).on("blur",function(){$(this).popover("hide")});$("button#staff_attr_del_btn").popover({content:"请先在左侧团员列表选中其一",placement:"top",trigger:"manual"}).on("click",deleteStaff).on("blur",function(){$(this).popover("hide")})}function bindEvents(){$("div#staff_list").children("div").on("click","button",function(c){readStaffAttributes(c,$(this).index())});window.onbeforeunload=saveToLocal;$("div#staff_list_filter").find("input[name='options']").on("change",filterStaff);$("input#staff_search").on("change keydown",function(c){if(c.type==="keydown"&&c.keyCode!==13){return}let $list=$("div#staff_list").children("div").children("button");let key=$(this).val();if(key===""){$list.show()}else{$list.hide().filter(":contains("+key+")").show()}});$("input#schedule_search").on("change keydown",function(c){if(c.type==="keydown"&&c.keyCode!==13){return}let $cell=$("div#schedule").find("tbody tr td");let key=$(this).val();if(key===""){$cell.removeClass("schedule-search-result")}else{$cell.removeClass("schedule-search-result").filter(":contains("+key+")").addClass("schedule-search-result")}});$("div#modal_add_name").on("show.bs.modal",function(){$(this).css("display","block");let modalHeight=$(window).height()/2-$("div#modal_add_name").find(".modal-dialog").height()/2;$(this).find(".modal-dialog").css({"margin-top":modalHeight})}).on("shown.bs.modal",function(){$("input#modal_add_name_input").focus()});$("input#modal_add_name_input").on("keydown",function(c){if(c.keyCode===13){addName();$(this).val("")}});$("div#modal_authorize").on("show.bs.modal",function(){$(this).css("display","block");let modalHeight=$(window).height()/2-$("div#modal_authorize").find(".modal-dialog").height()/2;$(this).find(".modal-dialog").css({"margin-top":modalHeight})}).on("shown.bs.modal",function(){$("input#modal_authorize_input").focus()});$("input#modal_authorize_input").on("keydown",function(c){if(c.keyCode===13){checkAuth()}});const b=["A","B","C","D","E","F","G"];const a=["20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30","0:00","0:30"];$("div#schedule").on("click","[name='row-add']",function(){let $table=$(this).parentsUntil("div#schedule").filter("table");let count=$table.find("tbody tr").length;if(count>=7){return}$table.append('<tr><th scope="row">'+b[count]+"队</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");resizeSVG()}).on("click","[name='row-delete']",function(){let $tr=$(this).parentsUntil("div#schedule").filter("table").find("tbody tr");let count=$tr.length;if(count<=1){return}$tr.eq(count-1).remove();resizeSVG()}).on("click","[name='chart-add']",function(){let count=$("div#schedule").children("table").length;if(count>=10){return}$('<table class="table table-bordered text-center">\n<thead>\n<tr>\n    <th class="bg-success">'+a[count]+'\n        <span class="pull-right">\n            <button title="在该时间段末尾增加一个团"  type="button" class="btn btn-info btn-xxs" name="row-add">\n                <span class="glyphicon glyphicon-plus"></span>\n            </button>\n            <button title="将该时间段末尾的团删去" type="button" class="btn btn-info btn-xxs" name="row-delete">\n                <span class="glyphicon glyphicon-minus"></span>\n            </button>\n        </span>\n    </th>\n    <th class="text-center" colspan="4">光</th>\n    <th class="text-center" colspan="4">暗</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n    <th scope="row">A队</th>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n</tr>\n</tbody>\n</table>').insertBefore("div#schedule>div");resizeSVG()}).on("click","[name='chart-delete']",function(){let $table=$("div#schedule").children("table");let count=$table.length;if(count<=1){return}$table.eq(count-1).remove();resizeSVG()});$("button#export_btn").on("click",function(){console.log("export");html2canvas($("div#schedule").get(0)).then(function(c){$("img#screen_shot_img").attr("src",c.toDataURL())});$("div#modal_img").modal("show")})}function experience(){sessionStorage.authorized="none";$("div#modal_authorize").modal("hide")}function checkAuth(){let code=$("input#modal_authorize_input").val().trim();let $enter=$("button#btn_auth_enter");let $help=$("span#helpBlock");let result=md5(code);if(result===staticLocalJson.auth_pre){$help.text("团长授权：可保存所有改动");$enter.prop("disabled",false)}else{if(result===staticLocalJson.auth_fun){$help.text("团员授权：只可保存团员区改动");$enter.prop("disabled",false)}else{$help.text("授权码不对，无保存权限，请联系小明");$enter.prop("disabled",true)}}}function authorize(){let code=$("input#modal_authorize_input").val().trim();let result=md5(code);if(result===staticLocalJson.auth_pre){sessionStorage.authorized="premium"}else{if(result===staticLocalJson.auth_fun){sessionStorage.authorized="fundamental"}else{sessionStorage.authorized="none";$("span#helpBlock").text("授权码不对，无保存权限，请联系小明");return}}$("div#modal_authorize").modal("hide")}function readStaffAttributes(b,a){let id=parseInt(b.target.getAttribute("data-id"));$("div#staff_attr_panel").attr("data-id",id);if(id===staticLocalJson.staff_auto_increment){$("select#staff_attr_name_select").val(-1);$("input#staff_attr_career_input").val("");$("select#staff_attr_type_select").val(0);$("input#staff_attr_absence_check").prop("checked",false);$("div#staff_attr_other_attack").children("label").removeClass("active").eq(0).addClass("active");$("div#staff_attr_other_control").children("label").removeClass("active").eq(0).addClass("active");$("div#staff_attr_other_element").children("label").removeClass("active").eq(0).addClass("active");return}let list=staticLocalJson.staff_list;if(list[a].id===id){let index_namelist=staticNameList.indexOf(list[a].name);$("select#staff_attr_name_select").val(index_namelist);$("input#staff_attr_career_input").val(list[a].career);$("select#staff_attr_type_select").val(list[a].type);$("input#staff_attr_absence_check").prop("checked",list[a].absence);$("div#staff_attr_other_attack").children("label").removeClass("active").eq(list[a].attack-1).addClass("active");$("div#staff_attr_other_control").children("label").removeClass("active").eq(list[a].control-1).addClass("active");$("div#staff_attr_other_element").children("label").removeClass("active").eq(list[a].element-1).addClass("active")}else{console.log(a+" "+list[a].id+" "+id);alert("错误代码600，请告知小明")}}function loadStaffList(){let $staff_list=$("div#staff_list").children("div");$staff_list.empty();$.each(staticLocalJson.staff_list,function(a,b){if(staticNameList.indexOf(b.name)===-1){staticNameList.push(b.name)}let elementNode=document.createElement("button");elementNode.setAttribute("type","button");elementNode.setAttribute("data-id",b.id);elementNode.className="btn btn-default";elementNode.innerHTML=b.name+b.career;if(b.type===1){elementNode.className+=" career-c"}else{if(b.type===2){elementNode.className+=" career-assist"}else{if(b.type===3){elementNode.className+=" career-priest"}}}if(b.absence){elementNode.className+=" career-absence"}$staff_list.append(elementNode)});resizeSVG();loadNameList()}function loadNameList(){let $name_select=$("select#staff_attr_name_select");$name_select.empty();$name_select.append(new Option("称谓","-1"));$.each(staticNameList,function(a,b){$name_select.append(new Option(b,a))})}function loadCheck(){let $cell=$("div#schedule").find("tbody tr td");let $staff=$("div#staff_list").children("div").find("button");$cell.each(function(){let text=$(this).text();if(text===null||text===""||text==="空"){return}let $target=$staff.filter(":contains("+text+")");$target.each(function(){if($(this).text()===text){if($(this).hasClass("career-absence")){$cell.removeAttr("data-name").text("")}else{if(!$(this).hasClass("in-schedule")){$(this).addClass("in-schedule")}}}})})}function filterStaff(){let filterConditions=[".career-c",".career-assist",".career-priest",".in-schedule",".career-absence"];let $filterInputs=$("div#staff_list_filter").find("input");$filterInputs.each(function(){let index=parseInt($(this).attr("data-filter"));if($(this).parent().hasClass("active")){$("div#staff_list").find(filterConditions[index-1]).show()}else{$("div#staff_list").find(filterConditions[index-1]).hide()}})}function addStaff(){let $btn_list=$("div#staff_list").children("div");let increment=staticLocalJson.staff_auto_increment;let exist=$btn_list.children("button").is("[data-id="+increment+"]");if(exist){$("button#staff_list_add_btn").popover("show");return}let elementNode=document.createElement("button");elementNode.setAttribute("type","button");elementNode.setAttribute("data-id",increment.toString());elementNode.className="btn btn-default";elementNode.innerHTML="新增人员";$btn_list.append(elementNode)}function addName(){let $input=$("input#modal_add_name_input");let name=$input.val().trim();let $modal=$("div#modal_add_name");if(name===null||name===""){$modal.modal("hide");return}staticNameList.push(name);loadNameList();$("select#staff_attr_name_select").val(staticNameList.length-1);$modal.modal("hide");$input.val("")}function saveStaff(){let id=parseInt($("div#staff_attr_panel").attr("data-id"));let $staff_btn=$("div#staff_list").children("div").children("button[data-id="+id+"]");if(id===-1||!$staff_btn.is("button")){$("button#staff_attr_save_btn").popover("show");return}let staff={id:id,name:staticNameList[parseInt($("select#staff_attr_name_select").val())],career:$("input#staff_attr_career_input").val().trim(),type:parseInt($("select#staff_attr_type_select").val()),absence:$("input#staff_attr_absence_check").prop("checked"),attack:$("div#staff_attr_other_attack").find("label.active").index()+1,control:$("div#staff_attr_other_control").find("label.active").index()+1,element:$("div#staff_attr_other_element").find("label.active").index()+1};if(staff.id===staticLocalJson.staff_auto_increment){staticLocalJson.staff_list.push(staff);staticLocalJson.staff_auto_increment++}else{let index=$staff_btn.index();if(staticLocalJson.staff_list[index].id===staff.id){staticLocalJson.staff_list[index]=staff}else{alert("错误代码601，请告知小明")}}$staff_btn.text(staff.name+staff.career);if(staff.type===1){$staff_btn.attr("class","btn btn-default career-c")}else{if(staff.type===2){$staff_btn.attr("class","btn btn-default career-assist")}else{if(staff.type===3){$staff_btn.attr("class","btn btn-default career-priest")}else{if(staff.type===0){$staff_btn.attr("class","btn btn-default")}}}}if(staff.absence){$staff_btn.addClass("career-absence")}}function deleteStaff(){let id=parseInt($("div#staff_attr_panel").attr("data-id"));let $staff_btn=$("div#staff_list").children("div").children("button[data-id="+id+"]");if(id===-1||!$staff_btn.is("button")){$("button#staff_attr_del_btn").popover("show");return}let index=$staff_btn.index();$staff_btn.remove();if(staticLocalJson.staff_auto_increment===id){return}if(staticLocalJson.staff_list[index].id===id){staticLocalJson.staff_list.splice(index,1)}else{alert("错误代码602，请告知小明")}}function saveToLocal(){if(sessionStorage.authorized===null||sessionStorage.authorized==="none"){return}if(sessionStorage.authorized==="premium"){$.ajax({method:"post",url:"php/saveChart.php",async:false,data:{toStore:$("div#schedule").html()}})}if(sessionStorage.authorized==="fundamental"||sessionStorage.authorized==="premium"){let dataToStore=JSON.stringify(staticLocalJson,null,4);$.ajax({method:"post",url:"php/saveJSON.php",async:false,data:{toStore:dataToStore}})}}function makeDraggable(a,b){if(!a instanceof jQuery){return}let isMove=false;let X,Y;b.on("mousedown",function(c){isMove=true;X=c.pageX-parseInt(a.css("left"));Y=c.pageY-parseInt(a.css("top"))});$(document).on("mousemove",function(c){if(isMove){let left=c.pageX-X;let top=c.pageY-Y;a.css({left:left,top:top})}}).on("mouseup",function(){isMove=false})}function resizeSVG(){$(".line").css({width:document.body.scrollWidth,height:document.body.scrollHeight})}function bindDrawLine(){$(".line").css({width:document.body.scrollWidth,height:document.body.scrollHeight});let isDraw=false,isDrop=false,isExchange=false;let $svg=$("svg");let staffId;let index;let $td;let $buttons=$("div#staff_list").children("div");$buttons.on("mousedown","button",function(a){isDraw=true;staffId=parseInt($(a.target).attr("data-id"));index=parseInt($(a.target).index());$svg.children("line").attr({x1:a.pageX,y1:a.pageY,x2:a.pageX,y2:a.pageY})});let $schedule=$("div#schedule");$schedule.on("mousedown","table tr td",function(a){isDraw=true;isExchange=true;$td=$(a.target);$svg.children("line").attr({x1:a.pageX,y1:a.pageY,x2:a.pageX,y2:a.pageY})});$(document).on("mousemove",function(a){if(isDraw){if(!$svg.is(":visible")){$svg.show()}$svg.children("line").attr({x2:a.pageX,y2:a.pageY})}}).on("mouseup",function(){if(isDraw){isDraw=false;$svg.hide();isDrop=true;setTimeout(function(){isDrop=false},50)}});$schedule.on("mouseover","table tr td",function(){if(isDrop){if(isExchange){let staff_name=$td.attr("data-name");let staff_text=$td.text();let $target=$(this);let this_name=$target.attr("data-name");let this_text=$target.text();$td.attr("data-name",!this_name?"":this_name);$td.text(!this_text?"":this_text);$target.attr("data-name",!staff_name?"":staff_name);$target.text(!staff_text?"":staff_text);isExchange=false;markDuplicate(false,$td);markDuplicate(false,$target);return}let staff=staticLocalJson.staff_list[index];if(staff.id===staffId){let staff_out_text=$(this).text();let $staff_list=$("div#staff_list");if(staff.name!=="空"){let text=staff.name+staff.career;let $contain=$("div#schedule").find("tbody tr td").filter(":contains("+text+")");$contain.each(function(){if($(this).text()===text){$(this).removeAttr("data-name").text("");markDuplicate(false,$(this))}})}$(this).attr("data-name",staff.name).text(staff.name+staff.career);let $staff_in=$staff_list.find("button[data-id="+staffId+"]");if(!$staff_in.hasClass("in-schedule")&&staff.name!=="空"){$staff_in.addClass("in-schedule");if($("div#staff_list_filter").find("input[data-filter=4]").prop("checked")===false){$staff_in.hide()}}if(staff_out_text!==""&&staff_out_text!=="空"){let $contain=$staff_list.find("button:contains("+staff_out_text+")");$contain.each(function(){if($(this).text()===staff_out_text){$(this).removeClass("in-schedule").show()}})}}else{alert("错误代码603，请告知小明")}isDrop=false;markDuplicate(false,$(this))}})}function markDuplicate(a){if(a){}else{if(typeof arguments[1]==="object"){let $obj=arguments[1];let $td=$obj.parentsUntil("table").find("td");$td.css("color","");let map={};$.each($td,function(){let key=$(this).attr("data-name");if(key!=="空"&&!!key){if(typeof map[key]==="undefined"){map[key]=1}else{if(map[key]===1){$td.filter("[data-name="+key+"]").css("color","red");map[key]=2}}}})}else{alert("错误代码701，请告知小明")}}};