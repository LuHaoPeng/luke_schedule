"use strict";let staticLocalJson={staff_auto_increment:0,staff_list:[],last_schedule:""};let staticNameList=[];$(document).ready(function(){init(function(){loadStaffList();if(staticLocalJson.last_schedule!==""){$("div#schedule").html(staticLocalJson.last_schedule)}});$("div#schedule").children("h3").text(new Date().toLocaleDateString().replace(/\//g,"-"));initPopovers();$("input#edit_lock").bootstrapSwitch({state:false,size:"small",onText:"\u2714",offText:"\u2718",onSwitchChange:function(){let state=$("input#edit_lock").bootstrapSwitch("state");let $chart=$("div#schedule");if(state===true){$chart.find("table thead th").children("span").show();$chart.children("div").show()}else{if(state===false){$chart.find("table thead th").children("span").hide();$chart.children("div").hide()}}}});bindEvents();bindDrawLine();makeDraggable($("div#staff_list"),$("button#staff_list_move_handle"));$("div#modal_add_name").on("show.bs.modal",function(){$(this).css("display","block");let modalHeight=$(window).height()/2-$("div#modal_add_name").find(".modal-dialog").height()/2;$(this).find(".modal-dialog").css({"margin-top":modalHeight})}).on("shown.bs.modal",function(){$("input#modal_add_name_input").focus()});$("input#modal_add_name_input").on("keydown",function(a){if(a.keyCode===13){addName();$(this).val("")}})});function init(a){$.getJSON("data/luke_config.json",function(b){if(b==null){return}staticLocalJson=b}).done(a)}function initPopovers(){$("button#staff_list_add_btn").popover({content:"一次只能新增一个空白团员",placement:"top",trigger:"manual"}).on("click",addStaff).on("blur",function(){$(this).popover("hide")});$("button#staff_attr_save_btn").popover({content:"请先在左侧团员列表选中其一",placement:"top",trigger:"manual"}).on("click",saveStaff).on("blur",function(){$(this).popover("hide")});$("button#staff_attr_del_btn").popover({content:"请先在左侧团员列表选中其一",placement:"top",trigger:"manual"}).on("click",deleteStaff).on("blur",function(){$(this).popover("hide")})}function bindEvents(){$("div#staff_list").children("div").on("click","button",function(c){readStaffAttributes(c,$(this).index())});window.onbeforeunload=saveToLocal;$("div#staff_list_filter").find("input[name='options']").on("change",function(){let type=$(this).attr("data-filter");let className;if(type==="1"){className=".career-c"}else{if(type==="2"){className=".career-assist"}else{if(type==="3"){className=".career-priest"}else{if(type==="4"){className=".in-schedule"}else{if(type==="5"){className=".career-absence"}}}}}if($(this).parent().hasClass("active")){$("div#staff_list").find(className).show()}else{$("div#staff_list").find(className).hide()}});const b=["A","B","C","D","E","F","G"];const a=["20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30","0:00","0:30"];$("div#schedule").on("click","[name='row-add']",function(){let $table=$(this).parentsUntil("div#schedule").filter("table");let count=$table.find("tbody tr").length;if(count>=7){return}$table.append('<tr><th scope="row">'+b[count]+"队</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");resizeSVG()}).on("click","[name='row-delete']",function(){let $tr=$(this).parentsUntil("div#schedule").filter("table").find("tbody tr");let count=$tr.length;if(count<=1){return}$tr.eq(count-1).remove();resizeSVG()}).on("click","[name='chart-add']",function(){let count=$("div#schedule").children("table").length;if(count>=10){return}$('<table class="table table-bordered text-center">\n<thead>\n<tr>\n    <th class="bg-success">'+a[count]+'\n        <span class="pull-right">\n            <button type="button" class="btn btn-info btn-xxs" name="row-add">\n                <span class="glyphicon glyphicon-plus"></span>\n            </button>\n            <button type="button" class="btn btn-info btn-xxs" name="row-delete">\n                <span class="glyphicon glyphicon-minus"></span>\n            </button>\n        </span>\n    </th>\n    <th class="text-center" colspan="4">光</th>\n    <th class="text-center" colspan="4">暗</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n    <th scope="row">A队</th>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n    <td></td>\n</tr>\n</tbody>\n</table>').insertBefore("div#schedule>div");resizeSVG()}).on("click","[name='chart-delete']",function(){let $table=$("div#schedule").children("table");let count=$table.length;if(count<=1){return}$table.eq(count-1).remove();resizeSVG()})}function readStaffAttributes(b,a){let id=parseInt(b.target.getAttribute("data-id"));$("div#staff_attr_panel").attr("data-id",id);if(id===staticLocalJson.staff_auto_increment){$("select#staff_attr_name_select").val(-1);$("input#staff_attr_career_input").val("");$("select#staff_attr_type_select").val(0);$("input#staff_attr_absence_check").prop("checked",false);$("div#staff_attr_other_attack").children("label").removeClass("active").eq(0).addClass("active");$("div#staff_attr_other_control").children("label").removeClass("active").eq(0).addClass("active");$("div#staff_attr_other_element").children("label").removeClass("active").eq(0).addClass("active");return}let list=staticLocalJson.staff_list;if(list[a].id===id){let index_namelist=staticNameList.indexOf(list[a].name);$("select#staff_attr_name_select").val(index_namelist);$("input#staff_attr_career_input").val(list[a].career);$("select#staff_attr_type_select").val(list[a].type);$("input#staff_attr_absence_check").prop("checked",list[a].absence);$("div#staff_attr_other_attack").children("label").removeClass("active").eq(list[a].attack-1).addClass("active");$("div#staff_attr_other_control").children("label").removeClass("active").eq(list[a].control-1).addClass("active");$("div#staff_attr_other_element").children("label").removeClass("active").eq(list[a].element-1).addClass("active")}else{console.log(a+" "+list[a].id+" "+id);alert("错误代码600，请告知小明")}}function loadStaffList(){let $staff_list=$("div#staff_list").children("div");$staff_list.empty();$.each(staticLocalJson.staff_list,function(a,b){if(staticNameList.indexOf(b.name)===-1){staticNameList.push(b.name)}let elementNode=document.createElement("button");elementNode.setAttribute("type","button");elementNode.setAttribute("data-id",b.id);elementNode.className="btn btn-default";elementNode.innerHTML=b.name+b.career;if(b.type===1){elementNode.className+=" career-c"}else{if(b.type===2){elementNode.className+=" career-assist"}else{if(b.type===3){elementNode.className+=" career-priest"}}}if(b.absence){elementNode.className+=" career-absence"}$staff_list.append(elementNode)});loadNameList()}function loadNameList(){let $name_select=$("select#staff_attr_name_select");$name_select.empty();$name_select.append(new Option("称谓","-1"));$.each(staticNameList,function(a,b){$name_select.append(new Option(b,a))})}function addStaff(){let $btn_list=$("div#staff_list").children("div");let increment=staticLocalJson.staff_auto_increment;let exist=$btn_list.children("button").is("[data-id="+increment+"]");if(exist){$("button#staff_list_add_btn").popover("show");return}let elementNode=document.createElement("button");elementNode.setAttribute("type","button");elementNode.setAttribute("data-id",increment.toString());elementNode.className="btn btn-default";elementNode.innerHTML="新增人员";$btn_list.append(elementNode)}function addName(){let name=$("input#modal_add_name_input").val().trim();let $modal=$("div#modal_add_name");if(name===null||name===""){$modal.modal("hide");return}staticNameList.push(name);loadNameList();$("select#staff_attr_name_select").val(staticNameList.length-1);$modal.modal("hide")}function saveStaff(){let id=parseInt($("div#staff_attr_panel").attr("data-id"));let $staff_btn=$("div#staff_list").children("div").children("button[data-id="+id+"]");if(id===-1||!$staff_btn.is("button")){$("button#staff_attr_save_btn").popover("show");return}let staff={id:id,name:staticNameList[parseInt($("select#staff_attr_name_select").val())],career:$("input#staff_attr_career_input").val().trim(),type:parseInt($("select#staff_attr_type_select").val()),absence:$("input#staff_attr_absence_check").prop("checked"),attack:$("div#staff_attr_other_attack").find("label.active").index()+1,control:$("div#staff_attr_other_control").find("label.active").index()+1,element:$("div#staff_attr_other_element").find("label.active").index()+1};if(staff.id===staticLocalJson.staff_auto_increment){staticLocalJson.staff_list.push(staff);staticLocalJson.staff_auto_increment++}else{let index=$staff_btn.index();if(staticLocalJson.staff_list[index].id===staff.id){staticLocalJson.staff_list[index]=staff}else{alert("错误代码601，请告知小明")}}$staff_btn.text(staff.name+staff.career);if(staff.type===1){$staff_btn.attr("class","btn btn-default career-c")}else{if(staff.type===2){$staff_btn.attr("class","btn btn-default career-assist")}else{if(staff.type===3){$staff_btn.attr("class","btn btn-default career-priest")}else{if(staff.type===0){$staff_btn.attr("class","btn btn-default")}}}}if(staff.absence){$staff_btn.addClass("career-absence")}}function deleteStaff(){let id=parseInt($("div#staff_attr_panel").attr("data-id"));let $staff_btn=$("div#staff_list").children("div").children("button[data-id="+id+"]");if(id===-1||!$staff_btn.is("button")){$("button#staff_attr_del_btn").popover("show");return}let index=$staff_btn.index();$staff_btn.remove();if(staticLocalJson.staff_auto_increment===id){return}if(staticLocalJson.staff_list[index].id===id){staticLocalJson.staff_list.splice(index,1)}else{alert("错误代码602，请告知小明")}}function saveToLocal(){staticLocalJson.last_schedule=$("div#schedule").html();let dataToStore=JSON.stringify(staticLocalJson,null,4);$.ajax({method:"post",url:"php/saveJSON.php",async:false,data:{toStore:dataToStore}}).done(function(a){console.log(a+" characters saved")})}function makeDraggable(a,b){if(!a instanceof jQuery){return}let isMove=false;let X,Y;b.on("mousedown",function(c){isMove=true;X=c.pageX-parseInt(a.css("left"));Y=c.pageY-parseInt(a.css("top"))});$(document).on("mousemove",function(c){if(isMove){let left=c.pageX-X;let top=c.pageY-Y;a.css({left:left,top:top})}}).on("mouseup",function(){isMove=false})}function resizeSVG(){$(".line").css({width:document.body.scrollWidth,height:document.body.scrollHeight})}function bindDrawLine(){$(".line").css({width:document.body.scrollWidth,height:document.body.scrollHeight});let staffId;let isDraw=false,isDrop=false;let $svg=$("svg");let $buttons=$("div#staff_list").children("div");$buttons.on("mousedown","button",function(a){isDraw=true;staffId=parseInt($(a.target).attr("data-id"));$svg.children("line").attr({x1:a.pageX,y1:a.pageY,x2:a.pageX,y2:a.pageY})});$(document).on("mousemove",function(a){if(isDraw){if(!$svg.is(":visible")){$svg.show()}$svg.children("line").attr({x2:a.pageX,y2:a.pageY})}}).on("mouseup",function(){if(isDraw){isDraw=false;$svg.hide();isDrop=true;setTimeout(function(){isDrop=false},10)}});$("div#schedule").on("mouseover","table tr td",function(){if(isDrop){let staff=staticLocalJson.staff_list[staffId-1];if(staff.id===staffId){$(this).attr({"data-name":staff.name}).text(staff.name+staff.career);let $staff_in=$("div#staff_list").find("button[data-id="+staffId+"]");if(!$staff_in.hasClass("in-schedule")){$staff_in.addClass("in-schedule");if($("div#staff_list_filter").find("input[data-filter=4]").prop("checked")===false){$staff_in.hide()}}}else{alert("错误代码603，请告知小明")}isDrop=false;markDuplicate(false,$(this))}})}function markDuplicate(a){if(a){}else{if(typeof arguments[1]==="object"){let $obj=arguments[1];let $td=$obj.parentsUntil("table").find("td");$td.css("color","");let map={};$.each($td,function(){let key=$(this).attr("data-name");if(typeof map[key]==="undefined"){map[key]=1}else{if(map[key]===1){$td.filter("[data-name="+key+"]").css("color","red");map[key]=2}}})}else{alert("错误代码701，请告知小明")}}};